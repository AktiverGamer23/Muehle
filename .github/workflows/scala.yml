# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Scala CI with Coveralls (No HEAD)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout (flach ist OK)
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1

      # 2️⃣ Java
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      # 3️⃣ sbt installieren
      - uses: olafurpg/setup-scala@v14
        with:
          sbt-version: '1.11.7'

      # 4️⃣ Tests + Coverage
      - name: Run tests and generate coverage
        run: sbt coverage test coverageReport
        working-directory: scalaerstes

      # 5️⃣ Python (bereits vorinstalliert auf ubuntu-latest)
      - name: Convert Scoverage XML to LCOV
        run: |
          python3 - << 'EOF'
          import xml.etree.ElementTree as ET

          tree = ET.parse('scalaerstes/target/scala-3.7.3/scoverage-report/scoverage.xml')
          root = tree.getroot()

          with open('scalaerstes/target/scala-3.7.3/scoverage-report/scoverage.lcov', 'w') as f:
              for cls in root.findall('.//class'):
                  filename = cls.attrib['filename']
                  for stmt in cls.findall('.//statement'):
                      line = stmt.attrib['line']
                      hits = stmt.attrib['invocation-count']
                      f.write(f"SF:{filename}\n")
                      f.write(f"DA:{line},{hits}\n")
                      f.write("end_of_record\n")
          EOF

      # 6️⃣ Coveralls upload
      - name: Send coverage to Coveralls
        run: |
          cat scalaerstes/target/scala-3.7.3/scoverage-report/scoverage.lcov | npx coveralls --repo-token ${{ secrets.COVERALLS_REPO_TOKEN }}
